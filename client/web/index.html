<!DOCTYPE html>
<html>
  <head>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no"
    />
    <title>CO2</title>
    <script>
      const entries = [];
      const getLatestMeasurement = async () => {
        return new Promise((resolve) => {
          fetch("./latest.json").then((res) => {
            if (res.ok) {
              res.json().then((data) => {
                const { date: olddate, time: oldtime } =
                  entries[entries.length - 1] || {};
                if (olddate === data.date && oldtime === data.time) {
                  // do nothing
                } else {
                  entries.push(data);
                  const elem = document.getElementById("table");
                  const trElem = document.createElement("tr");
                  Object.values(data).forEach((val) => {
                    trElem.appendChild(
                      (() => {
                        const tdElem = document.createElement("td");
                        tdElem.innerText = val;
                        return tdElem;
                      })()
                    );
                  });
                  elem.appendChild(trElem);
                }
              });
            }
          });
        });
      };
      const getAllMeasurements = async () => {
        fetch("./raw.csv").then((res) => {
          if (res.ok) {
            res.text().then((data) => {
              Array.from(document.getElementsByClassName("gen")).forEach((e) =>
                e.remove()
              );
              allEntries = data.split("\n");
              allEntries.forEach((e) => {
                const [, ...data] = e.split(",");
                const elem = document.getElementById("table");
                const trElem = document.createElement("tr");
                trElem.className = "gen";
                Object.values(data).forEach((val) => {
                  trElem.appendChild(
                    (() => {
                      const tdElem = document.createElement("td");
                      tdElem.innerText = val;
                      return tdElem;
                    })()
                  );
                });
                elem.appendChild(trElem);
              });
            });
          }
        });
      };
    </script>
    <script>
      getAllMeasurements();
      window.setInterval(() => {
        getAllMeasurements();
      }, 5000);
    </script>
  </head>
  <body style="font-size: 1rem">
    <table id="table" style="width: 100%; border-collapse: collapse">
      <tr>
        <th style="text-align: left">Date</th>
        <th style="text-align: left">Time</th>
        <th style="text-align: left">CO2</th>
        <th style="text-align: left">Temperature</th>
        <th style="text-align: left">Humidity</th>
      </tr>
    </table>
  </body>
</html>
